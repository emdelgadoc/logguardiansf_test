php<?php
/**
 * Sistema de Notificaciones por Correo
 * LogGuardianSF
 * 
 * Ejecutar v√≠a CRON cada 6 horas
 */

// Cargar configuraci√≥n
$config = require_once __DIR__ . '/notifier-config.php';

// Verificar si est√° habilitado
if (!$config['enabled']) {
    exit(0);
}

date_default_timezone_set('UTC');

// =============================
// VERIFICAR THROTTLING
// =============================
$lastNotificationFile = $config['last_notification'];

if (file_exists($lastNotificationFile) && $config['frequency'] === 'digest') {
    $lastTime = (int)file_get_contents($lastNotificationFile);
    $elapsedHours = (time() - $lastTime) / 3600;
    
    if ($elapsedHours < $config['digest_hours']) {
        exit(0); // A√∫n no es tiempo
    }
}


// =============================
// LEER LOGS
// =============================
$logFile = $config['log_file'];

if (!file_exists($logFile)) {
    exit(0);
}

$cutoffTime = time() - ($config['digest_hours'] * 3600);
$suspiciousIPs = [];
$lines = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

foreach ($lines as $line) {
    $parts = explode('|', $line);
    if (count($parts) < 9) continue;
    
    $datetime = strtotime($parts[0]);
    if ($datetime < $cutoffTime) continue;
    
    $ip = trim($parts[2]);
    $agent = strtolower(trim($parts[8]));
    $referer = strtolower(trim($parts[7]));
    $request = strtolower(trim($parts[4]));
    $code = trim($parts[5]);
    
    // Verificar whitelist
    if (isWhitelisted($ip, $agent, $config)) continue;

    // Detectar nivel
    $level = detectThreatLevel($parts, $config);
    
    if ($level !== 'safe') {
        if (!isset($suspiciousIPs[$ip])) {
            $suspiciousIPs[$ip] = [
                'level' => $level,
                'count' => 0,
                'first_seen' => $parts[0],
                'last_seen' => $parts[0],
                'domains' => [],
                'samples' => []
            ];
        }
        
        $suspiciousIPs[$ip]['count']++;
        $suspiciousIPs[$ip]['last_seen'] = $parts[0];
        $suspiciousIPs[$ip]['domains'][] = $parts[1];

        if (count($suspiciousIPs[$ip]['samples']) < $config['max_samples_per_ip']) {
            $suspiciousIPs[$ip]['samples'][] = [
                'datetime' => $parts[0],
                'domain' => $parts[1],
                'method' => $parts[3],
                'request' => $parts[4],
                'code' => $code,
                'agent' => $parts[8]
            ];
        }
        
        if ($level === 'critical') {
            $suspiciousIPs[$ip]['level'] = 'critical';
        } elseif ($level === 'high' && $suspiciousIPs[$ip]['level'] === 'suspicious') {
            $suspiciousIPs[$ip]['level'] = 'high';
        }
    }
}

// =============================
// FILTRAR POR UMBRALES
// =============================
$toNotify = [];

foreach ($suspiciousIPs as $ip => $data) {
    $levelConfig = $config['alert_levels'][$data['level']];
    
    if (!$levelConfig['enabled']) continue;
    
    if ($data['count'] >= $levelConfig['min_occurrences']) {
        $toNotify[$ip] = $data;
    }
}

// =============================
// VERIFICAR SI HAY ALGO
// =============================
if (empty($toNotify)) {
    file_put_contents($lastNotificationFile, time());
    exit(0);
}

if (count($toNotify) < $config['thresholds']['min_suspicious_count']) {
    file_put_contents($lastNotificationFile, time());
    exit(0);
}

// =============================
// AGRUPAR POR NIVEL
// =============================
$grouped = [
    'critical' => [],
    'high' => [],
    'suspicious' => []
];

foreach ($toNotify as $ip => $data) {
    $grouped[$data['level']][$ip] = $data;
}

// =============================
// ENVIAR CORREO
// =============================
$emailBody = generateEmailBody($grouped, $config);
$subject = generateSubject($grouped);

sendEmail($subject, $emailBody, $config);

// =============================
// REGISTRAR
// =============================
file_put_contents($lastNotificationFile, time());

foreach ($toNotify as $ip => $data) {
    $logEntry = sprintf(
        "[%s] IP: %s | Level: %s | Count: %d\n",
        date('Y-m-d H:i:s'),
        $ip,
        $data['level'],
        $data['count']
    );
    file_put_contents($config['notified_log'], $logEntry, FILE_APPEND);
}


echo "‚úì Notification sent: " . count($toNotify) . " suspicious IPs\n";

// =============================
// FUNCIONES
// =============================

function isWhitelisted($ip, $agent, $config)
{
    if (in_array($ip, $config['whitelist'])) {
        return true;
    }
    
    foreach ($config['whitelist_agents'] as $pattern) {
        if (stripos($agent, strtolower($pattern)) !== false) {
            return true;
        }
    }
    
    return false;
}

function detectThreatLevel($parts, $config)
{
    $code = trim($parts[5]);
    $agent = strtolower(trim($parts[8]));
    $request = strtolower(trim($parts[4]));
    $referer = strtolower(trim($parts[7]));
    
    // CRITICAL
    $criticalTools = ['masscan', 'nmap', 'sqlmap', 'nikto', 'metasploit', 'attack', 'exploit'];
    foreach ($criticalTools as $tool) {
        if (strpos($agent, $tool) !== false) {
            return 'critical';
        }
    }
    
    if (strpos($request, 'union select') !== false || 
        strpos($request, '<script') !== false ||
        strpos($request, '../') !== false) {
        return 'critical';
    }

    // HIGH
    if (strpos($request, 'phpmyadmin') !== false ||
        strpos($request, 'wp-admin') !== false ||
        strpos($request, '.env') !== false) {
        return 'high';
    }
    
    // SUSPICIOUS
    if (strpos($referer, 'scan') !== false ||
        strpos($agent, 'crawler') !== false ||
        strpos($agent, 'bot') !== false) {
        return 'suspicious';
    }
    
    return 'safe';
}

function generateSubject($grouped)
{
    $total = count($grouped['critical']) + count($grouped['high']) + count($grouped['suspicious']);
    
    if (count($grouped['critical']) > 0) {
        return "üö® CRITICAL: " . count($grouped['critical']) . " Attack IPs - " . gethostname();
    } elseif (count($grouped['high']) > 0) {
        return "‚ö†Ô∏è HIGH: " . count($grouped['high']) . " High-Risk IPs - " . gethostname();
    } else {
        return "‚ö†Ô∏è Alert: " . $total . " Suspicious IPs - " . gethostname();
    }
}

function generateEmailBody($grouped, $config)
{
    $html = '<!DOCTYPE html>
<html>
<head>
<style>
body{font-family:Arial;line-height:1.6;color:#333;margin:0;padding:0}
.header{background:#d32f2f;color:#fff;padding:20px;text-align:center}
.container{padding:20px;max-width:800px;margin:0 auto}
.section{margin:20px 0;padding:15px;border-left:4px solid #ccc}
.critical{border-left-color:#d32f2f;background:#ffebee}
.high{border-left-color:#f57c00;background:#fff3e0}
.suspicious{border-left-color:#fbc02d;background:#fffde7}
.ip-block{margin:10px 0;padding:10px;background:#fff;border-radius:4px}
.ip{font-weight:bold;font-size:16px;color:#d32f2f}
.details{font-size:13px;color:#666;margin:5px 0}
.sample{background:#f5f5f5;padding:8px;margin:5px 0;font-size:12px;font-family:monospace;word-break:break-all}
table{width:100%;border-collapse:collapse;margin:10px 0}
th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd}
th{background:#e0e0e0}
</style>
</head>
<body>
<div class="header">
<h1>üõ°Ô∏è LogGuardianSF Alert</h1>
<p>Security Event Detected</p>
<p>' . gethostname() . ' - ' . date('Y-m-d H:i:s') . ' UTC</p>
</div>
<div class="container">';

    $totalCritical = count($grouped['critical']);
    $totalHigh = count($grouped['high']);
    $totalSuspicious = count($grouped['suspicious']);
    
    $html .= '<h2>Summary</h2>
    <table>
    <tr><th>Level</th><th>Count</th><th>Action</th></tr>
    <tr style="background:#ffebee"><td>üö® CRITICAL</td><td>' . $totalCritical . '</td><td><b>Block immediately</b></td></tr>
    <tr style="background:#fff3e0"><td>‚ö†Ô∏è HIGH</td><td>' . $totalHigh . '</td><td>Review & block</td></tr>
    <tr style="background:#fffde7"><td>‚ö†Ô∏è SUSPICIOUS</td><td>' . $totalSuspicious . '</td><td>Monitor</td></tr>
    </table>';

    // CRITICAL
    if (!empty($grouped['critical'])) {
        $html .= '<div class="section critical"><h2>üö® CRITICAL THREATS (' . count($grouped['critical']) . ')</h2>';
        foreach (array_slice($grouped['critical'], 0, $config['thresholds']['max_ips_per_email']) as $ip => $data) {
            $html .= generateIPBlock($ip, $data, $config);
        }
        $html .= '</div>';
    }

    // HIGH
    if (!empty($grouped['high'])) {
        $html .= '<div class="section high"><h2>‚ö†Ô∏è HIGH RISK (' . count($grouped['high']) . ')</h2>';
        foreach (array_slice($grouped['high'], 0, $config['thresholds']['max_ips_per_email']) as $ip => $data) {
            $html .= generateIPBlock($ip, $data, $config);
        }
        $html .= '</div>';
    }

    // SUSPICIOUS
    if (!empty($grouped['suspicious'])) {
        $html .= '<div class="section suspicious"><h2>‚ö†Ô∏è SUSPICIOUS (' . count($grouped['suspicious']) . ')</h2>';
        foreach (array_slice($grouped['suspicious'], 0, $config['thresholds']['max_ips_per_email']) as $ip => $data) {
            $html .= generateIPBlock($ip, $data, $config);
        }
        $html .= '</div>';
    }
    
    $html .= '</div></body></html>';
    
    return $html;
}


